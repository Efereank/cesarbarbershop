let paso=1;const pasoInicial=1,pasoFinal=3,cita={id:"",nombre:"",fecha:"",hora:"",servicios:[],barberoId:""};function iniciarApp(){mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),consultarAPI(),idCliente(),nombreCliente(),seleccionarFecha(),inicializarSelectHora(),actualizarDuracionServicio(),mostrarResumen(),cargarBarberos()}function mostrarSeccion(){const e=document.querySelector(".mostrar");e&&e.classList.remove("mostrar");const o=`#paso-${paso}`;document.querySelector(o).classList.add("mostrar");const a=document.querySelector(".actual");a&&a.classList.remove("actual");document.querySelector(`[data-paso="${paso}"]`).classList.add("actual");const t=document.querySelector(".footer-total");t&&(t.style.display=3===paso?"none":"flex")}function tabs(){document.querySelectorAll(".tabs button").forEach(e=>{e.addEventListener("click",function(e){paso=parseInt(e.target.dataset.paso),mostrarSeccion(),botonesPaginador(),3===paso&&mostrarResumen(),actualizarFooterTotal()})})}function botonesPaginador(){const e=document.querySelector("#anterior"),o=document.querySelector("#siguiente");1===paso?(e.classList.add("ocultar"),o.classList.remove("ocultar")):3===paso?(e.classList.remove("ocultar"),o.classList.add("ocultar"),o&&o.classList.add("ocultar")):(e.classList.remove("ocultar"),o.classList.remove("ocultar"),o&&(o.textContent="Siguiente »")),mostrarSeccion()}function paginaAnterior(){document.querySelector("#anterior").addEventListener("click",function(){paso<=1||(paso--,botonesPaginador(),actualizarFooterTotal())})}function paginaSiguiente(){const e=document.querySelector("#siguiente");e&&e.addEventListener("click",function(){paso>=3?confirmarCita():(paso++,botonesPaginador(),3===paso&&mostrarResumen(),actualizarFooterTotal())})}function getBaseURL(){const e=window.location.hostname;window.location.port;return"localhost"===e||"127.0.0.1"===e?"http://localhost:3000":window.location.origin}async function consultarAPI(){const e=getBaseURL();console.log("Entorno detectado. Base URL:",e);try{const o=`${e}/api/servicios`;console.log("Consultando:",o);const a=await fetch(o,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},credentials:e.includes("localhost")?"omit":"same-origin",mode:"cors"});if(console.log("Status:",a.status),!a.ok){const e=await a.text();throw console.error("Error response:",e),new Error(`Error HTTP: ${a.status}`)}const t=await a.json();console.log("Servicios recibidos:",t),mostrarServicios(t)}catch(e){console.error("Error completo:",e),"TypeError"===e.name&&e.message.includes("Failed to fetch")?getBaseURL().includes("localhost")?mostrarAlerta("No se pudo conectar al servidor local. Verifica que el backend esté corriendo en puerto 3000.","error",".formulario"):mostrarAlerta("Error de conexión con el servidor.","error",".formulario"):mostrarAlerta("Error al cargar los servicios: "+e.message,"error",".formulario")}try{const o=`${e}/api/tasa`;console.log("Consultando tasa:",o);const a=await fetch(o,{headers:{Accept:"application/json"},credentials:e.includes("localhost")?"omit":"same-origin"});if(!a.ok)throw new Error(`Error HTTP: ${a.status}`);mostrarResumen(await a.json())}catch(e){console.error("Error en tasa:",e)}}function mostrarServicios(e){window.todosLosServicios=e;const o=document.querySelector("#servicio");o&&(o.innerHTML="",e.forEach(e=>{const{id:a,nombre:t,precio:r,duracion:i}=e,n=document.createElement("P");n.classList.add("nombre-servicio"),n.textContent=t;const c=document.createElement("P");c.classList.add("precio-servicio"),c.textContent=`$${r}`;const s=document.createElement("P");s.classList.add("duracion-servicio"),s.textContent=`${i} minutos`,s.style.fontSize="0.8rem",s.style.color="#666";const l=document.createElement("DIV");l.classList.add("servicio"),l.dataset.idServicio=a,l.dataset.duracion=i,l.addEventListener("click",function(){seleccionarServicio(e)}),cita.servicios.some(e=>e.id===a)&&l.classList.add("seleccionado"),l.appendChild(n),l.appendChild(c),l.appendChild(s),o.appendChild(l)}),actualizarFooterTotal())}function seleccionarServicio(e){const{id:o}=e,{servicios:a}=cita,t=document.querySelector(`[data-id-servicio="${o}"]`);-1!==a.findIndex(e=>e.id===o)?(cita.servicios=a.filter(e=>e.id!==o),t&&t.classList.remove("seleccionado")):(cita.servicios=[...a,e],t&&t.classList.add("seleccionado")),actualizarFooterTotal(),cita.fecha&&cargarHorariosDisponibles()}function idCliente(){const e=document.querySelector("#id").value;cita.id=e}function nombreCliente(){const e=document.querySelector("#nombre").value;cita.nombre=e}function mostrarAlerta(e,o,a,t=!0){const r=document.querySelector(".alerta");r&&r.remove();const i=document.createElement("DIV");i.textContent=e,i.classList.add("alerta"),i.classList.add(o);document.querySelector(a).appendChild(i),t&&setTimeout(()=>{i.remove()},9e3)}document.addEventListener("DOMContentLoaded",function(){iniciarApp()});let duracionServicio=15;function actualizarDuracionServicio(){const e=document.querySelector("#servicioId");e&&e.addEventListener("change",function(e){const o=e.target.value;duracionServicio={1:30,2:15,3:45,4:60,5:30,6:90}[o]||15;const a=document.querySelector("#hora");a&&a.value&&validarHoraCita()})}function calcularHoraFin(e,o){const[a,t]=e.split(":").map(Number),r=new Date;return r.setHours(a,t,0,0),r.setMinutes(r.getMinutes()+o),r.toTimeString().substring(0,5)}async function verificarDisponibilidad(e,o,a,t){try{const r=await fetch("/citas/verificar-disponibilidad",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:e,hora:o,hora_fin:a,duracion:t})}),i=await r.json();return i.disponible||Swal.fire({icon:"error",title:"Horario No Disponible",text:i.mensaje||"El barbero seleccionado ya tiene una cita en este horario.",confirmButtonText:"Actualizar",timer:5e3,timerProgressBar:!0}).then(e=>{window.location.reload()}),i}catch(e){return console.error("Error al verificar disponibilidad:",e),{disponible:!0}}}function seleccionarFecha(){const e=document.querySelector("#fecha");if(!e)return;const o=new Date,a=o.toISOString().split("T")[0],t=new Date;t.setDate(o.getDate()+4);const r=t.toISOString().split("T")[0];e.min=a,e.max=r,e.addEventListener("input",function(e){const o=new Date(e.target.value).getUTCDay();[0].includes(o)?(e.target.value="",mostrarAlerta("Los domingos no están permitidos","error",".formulario")):(cita.fecha=e.target.value,cargarHorariosDisponibles())})}function seleccionarHora(){const e=document.querySelector("#hora"),o=document.querySelector("#fecha");e.addEventListener("input",validarHoraCita),o.addEventListener("input",function(e){void 0!==cita&&(cita.fecha=e.target.value),validarHoraCita(e)}),actualizarDuracionServicio()}async function validarHoraCita(e){const o=document.querySelector("#hora"),a=document.querySelector("#fecha"),t=o.value;if(!t||!a.value)return void(void 0!==cita&&(cita.hora=""));const[r,i]=t.split(":"),n=parseInt(r,10),c=parseInt(i,10),s=new Date,l=new Date(s.toLocaleString("en-US",{timeZone:"America/Caracas"})),d=`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`,u=a.value,m=new Date(l.getTime()+9e5),p=m.getHours(),h=m.getMinutes();let f=!1,v="";(n<10||n>=20)&&(f=!0,v="Hora no válida. Nuestro horario de atención es de 10:00 a 20:00.");const b=calcularHoraFin(t,duracionServicio),[g,S]=b.split(":").map(Number);if((g>20||20===g&&S>0)&&(f=!0,v=`El servicio seleccionado terminaría a las ${b} fuera del horario de atención (hasta 20:00).`),u===d&&!f){let e=!1;n<p&&(e=!0),n===p&&c<h&&(e=!0),e&&(f=!0,v="Hora no válida. Las citas para hoy requieren un margen de 5 minutos.")}const y=document.querySelector(".alerta");if(f)o.value="",y&&y.textContent===v||(y&&y.remove(),mostrarAlerta(v,"error",".formulario")),void 0!==cita&&(cita.hora="");else{const e=calcularHoraFin(t,duracionServicio);try{const a=await verificarDisponibilidad(u,t,e,duracionServicio);a.disponible?(void 0!==cita&&(cita.hora=t,cita.hora_fin=e),y&&y.remove(),mostrarAlerta("Horario disponible ✓","exito",".formulario"),setTimeout(()=>{const e=document.querySelector(".alerta.exito");e&&e.remove()},3e3)):(o.value="",mostrarAlerta(a.mensaje||"Ya existe una cita en ese horario. Por favor, elige otra hora.","error",".formulario"),void 0!==cita&&(cita.hora=""))}catch(e){mostrarAlerta("Error al verificar disponibilidad. Confirma que el horario esté libre.","error",".formulario")}}}function obtenerDuracionServicio(){if(window.cita&&window.cita.servicios&&window.cita.servicios.length>0){let e=0;return window.cita.servicios.forEach(o=>{if(window.todosLosServicios){const a=window.todosLosServicios.find(e=>e.id===o.id);if(a&&a.duracion){const o=parseInt(a.duracion);e+=o}}else if(o.duracion){const a=parseInt(o.duracion);e+=a}}),e>0?e:15}const e=document.querySelectorAll(".servicio.seleccionado");if(0===e.length)return 15;let o=0;return e.forEach(e=>{const a=parseInt(e.dataset.duracion)||0;o+=a}),o>0?o:15}function inicializarSelectHora(){const e=document.querySelector("#hora");e&&e.addEventListener("change",function(){const e=this.value;if(e){if(cita.fecha){const o=validarHoraContraActual(cita.fecha,e);if(!o.valido)return mostrarAlerta(o.mensaje,"error",".formulario"),this.value="",void(cita.hora="")}cita.hora=e,cita.hora&&mostrarAlerta(`Hora seleccionada: ${cita.hora}`,"exito",".formulario",2e3)}else cita.hora=""})}async function cargarBarberos(){try{const e=await fetch("/api/barberos");mostrarBarberos(await e.json())}catch(e){console.error("Error al cargar barberos:",e),mostrarAlerta("Error al cargar la lista de barberos","error",".formulario")}}function mostrarBarberos(e){const o=document.querySelector("#barberoId");if(o){if(o.innerHTML='<option value="">Selecciona un barbero</option>',e&&e.length>0)e.forEach(e=>{const a=document.createElement("option");a.value=e.id,a.textContent=`${e.nombre} - ${e.especialidad||"Barbero"}`,o.appendChild(a)}),o.value="",cita.barberoId="",o.disabled=!1;else{const e=document.createElement("option");e.value="",e.textContent="No hay barberos disponibles",o.appendChild(e),o.disabled=!0}o.addEventListener("change",function(){cita.barberoId=this.value,cita.fecha&&cargarHorariosDisponibles()})}}async function cargarHorariosDisponibles(){const e=document.querySelector("#hora");if(e){if(!cita.fecha)return e.innerHTML='<option value="">Selecciona una fecha primero</option>',void(e.disabled=!0);if(!cita.barberoId)return e.innerHTML='<option value="">Selecciona un barbero primero</option>',void(e.disabled=!0);e.innerHTML='<option value="">Cargando horarios disponibles...</option>',e.disabled=!0;try{const o=calcularDuracionTotal(),a=[];for(let e=10;e<20;e++)for(let t=0;t<60;t+=15){const r=new Date;r.setHours(e,t+o,0,0);const i=new Date;if(i.setHours(20,0,0,0),r<=i){const o=e.toString().padStart(2,"0"),r=`${o}:${t.toString().padStart(2,"0")}`;validarHoraContraActual(cita.fecha,r).valido&&a.push(r)}}const t=[];for(const e of a){await verificarDisponibilidadIndividual(cita.fecha,e,o,cita.barberoId,!1)&&t.push({hora:e,display:e,disponible:!0})}if(e.innerHTML="",e.disabled=!1,t.length>0){const o=document.createElement("option");if(o.value="",o.textContent="Selecciona una hora",e.appendChild(o),t.forEach(o=>{const a=document.createElement("option");a.value=o.hora,a.textContent=o.display,e.appendChild(a)}),cita.hora){Array.from(e.options).find(e=>e.value===cita.hora)?e.value=cita.hora:cita.hora=""}}else e.innerHTML='<option value="">No hay horarios disponibles para esta fecha</option>',e.disabled=!0,mostrarAlerta("No hay horarios disponibles para la fecha seleccionada. Intenta con otra fecha o reduce los servicios.","error",".formulario")}catch(o){console.error("Error al cargar horarios:",o),e.innerHTML='<option value="">Error al cargar horarios</option>',e.disabled=!0,mostrarAlerta("Error al cargar los horarios disponibles","error",".formulario")}}}async function verificarDisponibilidadIndividual(e,o,a,t,r=!0){try{const i=await fetch("/citas/verificar-disponibilidad",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:e,hora:o,duracion:a,barberoId:t})});if(!i.ok)throw new Error("Error en la respuesta del servidor");const n=await i.json();return!!n.disponible||(r&&(await Swal.fire({icon:"error",title:"Horario No Disponible",text:n.mensaje,confirmButtonText:"Actualizar",timer:5e3,timerProgressBar:!0}),window.location.reload()),!1)}catch(e){return console.error("Error:",e),!1}}function calcularDuracionTotal(){return cita.servicios&&0!==cita.servicios.length?cita.servicios.reduce((e,o)=>e+(parseInt(o.duracion)||15),0):15}function validarHoraContraActual(e,o){const a=new Date,t=new Date(a.toLocaleString("en-US",{timeZone:"America/Caracas"})),[r,i,n]=e.split("-"),[c,s]=o.split(":"),l=new Date(r,i-1,n,c,s),d=new Date(t.getFullYear(),t.getMonth(),t.getDate()),u=new Date(l.getFullYear(),l.getMonth(),l.getDate());if(u.getTime()===d.getTime()){const e=5,o=new Date(t.getTime()+60*e*1e3);if(l<o){const a=t.toTimeString().substring(0,5);return{valido:!1,mensaje:`No puedes agendar citas para hoy antes de las ${o.toTimeString().substring(0,5)}. La hora actual es ${a}. Se requiere un margen de ${e} minutos.`}}}return u<d?{valido:!1,mensaje:"No puedes agendar citas para fechas pasadas."}:{valido:!0}}async function mostrarResumen(){const e=document.querySelector(".contenido-resumen");if(e){for(;e.firstChild;)e.removeChild(e.firstChild);if(Object.values(cita).includes("")||0===cita.servicios.length)mostrarAlerta("Faltan datos de Servicios, Fecha, u Hora.","error",".contenido-resumen",!1);else try{const o="http://localhost:3000/api/tasa",a=await fetch(o),t=await a.json();let r;if(Array.isArray(t)&&t.length>0){const e=t[t.length-1];r=parseFloat(e.tasaBs)||1}else r=t.tasaBs&&parseFloat(t.tasaBs)||1;isNaN(r)&&(r=1);const{nombre:i,fecha:n,hora:c,servicios:s,barberoId:l}=cita,d=obtenerDuracionServicio(),[u,m]=c.split(":").map(Number),p=new Date;p.setHours(u,m,0,0),p.setMinutes(p.getMinutes()+d);const h=p.toTimeString().slice(0,5),f=document.querySelector("#barberoId"),v=f?f.options[f.selectedIndex].textContent:"No seleccionado",b=document.createElement("H3");b.textContent="Servicios",e.appendChild(b),s.forEach(o=>{const{precio:a,nombre:t,duracion:r}=o,i=document.createElement("DIV");i.classList.add("contenedor-servicio");const n=document.createElement("p");n.textContent=t;const c=document.createElement("P");c.innerHTML=`<span>Precio:</span> $${a}`;const s=document.createElement("P");s.innerHTML=`<span>Duración:</span> ${r} minutos`;const l=document.createElement("P");l.innerHTML=`<span>Barbero:</span> ${v}`,i.appendChild(n),i.appendChild(c),i.appendChild(s),i.appendChild(l),e.appendChild(i)});const g=document.createElement("H3");g.textContent="Resumen de la Cita",e.appendChild(g);const S=document.createElement("P");S.innerHTML=`<span>Nombre:</span> ${i}`;const y=new Date(n),w=y.getMonth(),C=y.getDate()+2,E=y.getFullYear(),L=new Date(Date.UTC(E,w,C)),T={weekday:"long",year:"numeric",month:"long",day:"numeric"},D=L.toLocaleDateString("es-VE",T),H=document.createElement("P");H.innerHTML=`<span>Fecha:</span> ${D}`;const A=document.createElement("P");A.innerHTML=`<span>Horario:</span> ${c} - ${h}`;const q=s.reduce((e,o)=>e+parseFloat(o.precio),0),I=q*r,x=document.createElement("P");x.innerHTML=`<span>Total:</span> $${q.toFixed(2)}`;const $=document.createElement("P");$.innerHTML=`<span>Total Bs:</span> ${I.toFixed()} bs`;const P=document.createElement("BUTTON");P.classList.add("boton"),P.textContent="Reservar Cita",P.onclick=reservarCita,e.appendChild(S),e.appendChild(H),e.appendChild(A),e.appendChild(x),e.appendChild($),e.appendChild(P)}catch(e){console.error("Error al obtener la tasa:",e),mostrarAlerta("Error al obtener la tasa de cambio","error",".contenido-resumen",!1)}}}async function reservarCita(){if(!cita.barberoId||!cita.fecha||!cita.hora||0===cita.servicios.length)return void mostrarAlerta("Por favor completa todos los campos","error",".contenido-resumen");const{id:e,fecha:o,hora:a,servicios:t,barberoId:r}=cita,i=t.map(e=>e.id),n=obtenerDuracionServicio(),[c,s]=a.split(":").map(Number),l=60*c+s+n,d=l%60;Math.floor(l/60).toString().padStart(2,"0"),d.toString().padStart(2,"0");try{if(!await verificarDisponibilidadIndividual(o,a,n,r,!0))return}catch(e){return console.error("Error al verificar disponibilidad:",e),void mostrarAlerta("Error al verificar disponibilidad","error",".contenido-resumen")}const u=new FormData;u.append("usuarioId",e),u.append("fecha",o),u.append("hora",a),u.append("servicios",i),u.append("barberoId",r);try{const e="http://localhost:3000/api/citas",o=await fetch(e,{method:"POST",body:u});(await o.json()).resultado&&Swal.fire({icon:"success",title:"Cita Creada",text:"Tu cita ha sido creada exitósamente",button:"OK"}).then(()=>{setTimeout(()=>{window.location.reload()},1e3)})}catch(e){console.error("Error al reservar cita:",e),Swal.fire({icon:"error",title:"Oops...",text:e.message||"Algo salió mal. Por favor, intentalo más tarde"})}}